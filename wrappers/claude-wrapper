#!/bin/bash
# Wrapper for Claude Code CLI to track tasks in agent-inbox
# Creates task and exports AGENT_TASK_ID for hooks to use
# Hooks handle: running (UserPromptSubmit), completed (Stop), exited (SessionEnd)

# agent-inbox binary location
AGENT_INBOX="${AGENT_INBOX_BIN:-$HOME/.local/bin/agent-inbox}"

# Find the original claude binary
CLAUDE_BIN=$(which -a claude | grep -v "$(readlink -f "$0")" | head -n 1)

if [ -z "$CLAUDE_BIN" ]; then
    echo "Error: Could not find original claude binary" >&2
    exit 1
fi

# Generate unique task ID and export for hooks
export AGENT_TASK_ID=$(uuidgen)

# Get repo info if in a git repository
REPO_NAME=""
REPO_BRANCH=""
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    REPO_NAME=$(basename "$(git rev-parse --show-toplevel 2>/dev/null)" 2>/dev/null)
    REPO_BRANCH=$(git branch --show-current 2>/dev/null)
fi

# Build task title with repo/directory info
if [ -n "$REPO_NAME" ]; then
    # In a git repo - show repo name and branch
    TASK_TITLE="[$REPO_NAME"
    [ -n "$REPO_BRANCH" ] && TASK_TITLE="$TASK_TITLE:$REPO_BRANCH"
    TASK_TITLE="$TASK_TITLE]"
else
    # Not in a git repo - show directory name
    DIR_NAME=$(basename "$PWD")
    TASK_TITLE="[$DIR_NAME]"
fi

# Truncate to 100 chars
TASK_TITLE="${TASK_TITLE:0:100}"

# Register task as 'running'
agent-inbox report start "$AGENT_TASK_ID" "claude_code" "$PWD" "$TASK_TITLE" 2>/dev/null || true

# Run claude - hooks handle status updates
exec "$CLAUDE_BIN" "$@"
